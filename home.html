<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Familybook Home</title>
    <style>
        /* ваш CSS код */
    </style>
</head>
<body>
    <div class="header">
        <h1>Familybook</h1>
    </div>
    <div class="main-content">
        <div class="subscriptions">
            <h2>We subscriptions</h2>
            <ul id="subscriptionList"></ul>
        </div>
        <div class="news">
            <div class="publish">
                <textarea id="postText" rows="4" placeholder="Write something..."></textarea>
                <input type="file" id="postMedia" multiple />
                <button onclick="publishPost()">Publish</button>
            </div>
            <div id="newsFeed"></div>
        </div>
        <div class="my-family">
            <a href="family.html">My family</a>
        </div>
    </div>

    <script>
        const GITHUB_TOKEN = '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';
        const REPO_OWNER = 'Igor Vasenin';
        const REPO_NAME = 'Familybook';

        async function publishPost() {
            const postText = document.getElementById('postText').value;
            const postMedia = document.getElementById('postMedia').files;

            if (!postText && postMedia.length === 0) {
                alert("Please enter some text or select a media file.");
                return;
            }

            let mediaUrls = [];

            for (let i = 0; i < postMedia.length; i++) {
                const file = postMedia[i];
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function () {
                    mediaUrls.push(reader.result);
                    if (mediaUrls.length === postMedia.length) {
                        savePostToGitHub(postText, mediaUrls);
                    }
                };
            }

            if (postMedia.length === 0) {
                savePostToGitHub(postText, mediaUrls);
            }
        }

        async function savePostToGitHub(text, mediaUrls) {
            const post = {
                text: text,
                family: 'My family',
                timestamp: Date.now(),
                media: mediaUrls
            };

            let posts = await loadPostsFromGitHub();
            posts.push(post);

            const content = btoa(unescape(encodeURIComponent(JSON.stringify(posts, null, 2))));
            const sha = await getFileSha('posts.json');

            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/posts.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'New post',
                    content: content,
                    sha: sha
                })
            });

            if (response.ok) {
                document.getElementById('postText').value = '';
                document.getElementById('postMedia').value = '';
                loadNews();
            } else {
                console.error('Error saving post to GitHub:', await response.json());
            }
        }

        async function loadPostsFromGitHub() {
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/posts.json`, {
                headers: {
                    'Authorization': `token ${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}`
                }
            });

            if (response.ok) {
                const file = await response.json();
                const content = atob(file.content);
                return JSON.parse(content);
            } else {
                return [];
            }
        }

        async function getFileSha(path) {
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
                headers: {
                    'Authorization': `token ${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}`
                }
            });

            if (response.ok) {
                const file = await response.json();
                return file.sha;
            } else {
                return null;
            }
        }

        async function loadNews() {
            const newsFeedDiv = document.getElementById('newsFeed');
            newsFeedDiv.innerHTML = '';

            const posts = await loadPostsFromGitHub();

            posts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post';

                const postFamily = document.createElement('div');
                postFamily.textContent = `Family: ${post.family}`;

                const postText = document.createElement('div');
                postText.textContent = post.text;

                postDiv.appendChild(postFamily);
                postDiv.appendChild(postText);

                if (post.media && post.media.length > 0) {
                    post.media.forEach(mediaUrl => {
                        const mediaElement = document.createElement('img');
                        mediaElement.src = mediaUrl;
                        postDiv.appendChild(mediaElement);
                    });
                }

                newsFeedDiv.appendChild(postDiv);
            });
        }

        window.onload = function () {
            loadNews();
        }
    </script>
</body>
</html>
